name: Build and Deploy
run-name: ${{ github.actor }} Build and Deploy ðŸš€
on:
  push:
    branches:
      - "*" # Triggers on all branches for push events
  pull_request:
    branches:
      - "*" # Triggers on all branches for pull request events
jobs:
  deploy-to-prod:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn --frozen-lockfile

      - name: Auth CLI
        run: |
          yarn wix login --api-key $CLI_API_KEY
        env:
          CLI_API_KEY: ${{ secrets.CLI_API_KEY }}

      - name: CLI pull env
        if: github.event_name != 'pull_request'
        run: |
          yarn wix astro pull-env production

      - name: CLI pull env
        if: github.event_name == 'pull_request'
        run: |
          yarn wix astro pull-env pr-$PR_NUMBER
        env:
          PR_NUMBER: ${{ github.event.number }}

      - name: Build
        run: |
          yarn build

      - name: Deploy production
        if: github.event_name != 'pull_request'
        run: |
          yarn wix astro deploy --prod

      - name: Deploy preview
        id: deploy-preview
        if: github.event_name == 'pull_request'
        run: |
          {
            yarn wix astro deploy
          } >> "$GITHUB_OUTPUT"

      - name: Comment PR with deploy preview output
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
             ${{ join(steps.deploy-preview.outputs.output, ' ') }}
          comment-tag: deploy-preview-output
